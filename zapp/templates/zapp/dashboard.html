{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<h1>Welcome, {{ user.username }}!</h1>
<p>Full Name: {{ profile.full_name }}</p>
<p>Role: {{ profile.role }}</p>

<!-- Audio record buttons -->
<button id="startBtn">Start Recording</button>
<button id="stopBtn" disabled>Stop Recording</button>
<button id="uploadBtn" disabled>Upload Recording</button>

<!-- Audio player -->
<audio id="audioPlayback" controls></audio>

<!-- Real-time duration -->
<p>Recording duration: <span id="duration">0.0</span> sec</p>

<script>
let mediaRecorder;
let audioChunks = [];
let startTime;
let durationInterval;

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const uploadBtn = document.getElementById('uploadBtn');
const audioPlayback = document.getElementById('audioPlayback');
const durationDisplay = document.getElementById('duration');

startBtn.addEventListener('click', async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    startTime = Date.now();

    // Duration update
    durationInterval = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        durationDisplay.textContent = elapsed.toFixed(1);
    }, 100);

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
        clearInterval(durationInterval); // intervalni toâ€˜xtatish
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPlayback.src = audioUrl;
        uploadBtn.disabled = false;
    };

    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
});

stopBtn.addEventListener('click', () => {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
});

uploadBtn.addEventListener('click', () => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const formData = new FormData();
    formData.append('audio_file', audioBlob, 'recording.wav');

    fetch("{% url 'upload_audio' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        uploadBtn.disabled = true;
        durationDisplay.textContent = "0.0"; // durationni reset
    })
    .catch(err => console.error(err));
});
</script>
{% endblock %}